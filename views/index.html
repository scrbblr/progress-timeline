<!doctype html>
<html lang="fr" class="portrait preloading start-mode" data-color="yellow">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, maximum-scale=1, shrink-to-fit=no, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>scrbblr</title> 
<!--base href="http://playground.tifi.pagekite.me/yannick/"-->
<meta name="robots" content="noindex,nofollow">
<link rel="stylesheet" href="css/fonts.css">
<link rel="stylesheet" href="css/custom.css">
<!--link rel="stylesheet" href="https://unpkg.com/leaflet@1.0.3/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.0.3/dist/leaflet.js"></script>
  <link href="https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.css" rel='stylesheet' />
  <script src="https://api.tiles.mapbox.com/mapbox-gl-js/v0.35.1/mapbox-gl.js"></script>
  <script src="http://rawgit.com/mapbox/mapbox-gl-leaflet/master/leaflet-mapbox-gl.js"></script-->


<script src="vendors/jquery-3.3.1.min.js"></script>
<style>

</style>
<body>
<article class="page">
<nav class="calendar">
<div class="calendar-options">
  <div class="btn-calendar btn ico-calendar"></div>
</div>
<div class="calendar-dates-scroller">
<ul class="calendar-dates">

</ul>
</div>
</nav>

<div class="canvas"><div class="bounding-box"><img src="assets/data/sites/aerotropix/low/2016-12@0,5x.jpg" class="touchscreen"><div id="map"></div><img class="plan svg" src="assets/data/sites/aerotropix/plan.vector.svg" data-src-plan="assets/data/sites/aerotropix/plan.vector.svg"></div></div>
<time class="date main-date"><span class="day">DEC</span><span class="month">2016</span></time>
<div class="map-options"> 
  <div class="btn-timeline btn"><img src="images/timeline.svg" class="svg timeline-icon" id="timeliner"></div>
  <div class="btn-lock btn ico-lock"></div>
  <div class="btn-plan btn ico-plan"></div>
  <div class="btn-map btn ico-map"></div>
  <div class="btn-fullsize btn ico-fullsize"></div>
  <div class="btn-preload btn"><div class="preload-ratio col">0</div><div class="preload-info col"><b>HD</b><span>%</span></div></div>
</div>
<div class="related-options"> 
  <div class="btn-close ico-close"></div>
</div>
<section class="intro">
  <div class="intro-panel">
    <div class="color-panel bg-color">
      <div class="container">
        <h1><img src="images/scrbblr.eye.svg" class="logo svg"></h1>
        <h2>Visualize your construction progress with video drones.</h2>
        <div class="welcome">
          <div class="scroll-info ico-scroll"></div>
          <div class="progressbar">
            <span class="progressratio">loading...</span><br>
            <span class="label-project">84 Rivière St. Charles</span><br>
            <span class="ico-project pulse"></span>
          </div>
        </div>
        <div class="get-browser">
          <div class="flower ico-flowers"></div>
          <h3>Sorry, this won't work for you...</h3>
          <p>For now, only Webkit browsers are supported.<br>You can browse scrbblr with Safari on macOS/iOS or get Chrome <a href="https://www.google.de/chrome/">here</a> for your platform.</p>
        </div>
      </div>
      <nav class="side-menu"></nav>  
      <div class="option-menu">
        <div class="btn-fullscreen btn ico-fullscreen"></div>
        <nav class="btn-menu btn ico-menu"></nav>
      </div>
    </div>
  </div>
  <div class="project">
    <div class="project-panel">
      <div class="info bg-color-alt fg-color">
        <div class="col-2-3 info-left">
          <hr>
          <h1 class="ico-map">84 Rivière St. Charles</h1>
          <p>
            Le Centre Commercial de la Bichette at vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium.
          </p>
        </div><div class="col-1-3 align-right info-right">
          <hr>
          <a href="assets/data/sites/aerotropix/aerotropix.zip" class="project-download"><div class="btn-label">Download project archive</div><div class="ico-download"></div></a>
        </div>
      </div>
    </div>  
  </div>
</section>
<section class="timeline">
  <ul class="timescrub">
    <li class="timeline-options">
      <div class="btn-timeline btn ico-timeline-static"></div>
    </li>
    <li class="timeline-item first" data-date="2016-12-01" data-src-plan="assets/data/sites/aerotropix/plan.vector.svg" data-src-low="assets/data/sites/aerotropix/low/2016-12@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2016-12.jpg">
      <div class="timeline-step">
        <time><span class="day">DEC</span><span class="month">2016</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium At vero eos et accusamus et iusto odio dignissimos ducimus qui blanditiis praesentium</div>
      </div>
    </li>
    <li class="timeline-item" data-date="2017-02-01" data-src-low="assets/data/sites/aerotropix/low/2017-02@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2017-02.jpg">
      <div class="timeline-step">
        <time><span class="day">FEB</span><span class="month">2017</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">Proin quam velit, efficitur vel neque vitae, rhoncus commodo mi. Suspendisse finibus mauris et bibendum molestie. Aenean ex augue, varius et pulvinar in, pretium non nisi.</div>
      </div>
    </li>
    <li class="timeline-item" data-date="2017-03-01" data-src-low="assets/data/sites/aerotropix/low/2017-03@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2017-03.jpg">
      <div class="timeline-step">
        <time><span class="day">MAR</span><span class="month">2017</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">Proin iaculis, nibh eget efficitur varius, libero tellus porta dolor, at pulvinar tortor ex eget ligula. Integer eu dapibus arcu, sit amet sollicitudin eros.</div>
      </div>
    </li>
    <li class="timeline-item" data-date="2017-04-01" data-src-low="assets/data/sites/aerotropix/low/2017-04@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2017-04.jpg">
      <div class="timeline-step">
        <time><span class="day">APR</span><span class="month">2017</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">In mattis elit vitae odio posuere, nec maximus massa varius. Suspendisse varius volutpat mattis. Vestibulum id magna est.</div>
      </div>
    </li>
    <li class="timeline-item" data-date="2017-05-01" data-src-low="assets/data/sites/aerotropix/low/2017-05@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2017-05.jpg">
      <div class="timeline-step">
        <time><span class="day">MAI</span><span class="month">2017</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">In mattis elit vitae odio posuere, nec maximus massa varius. Suspendisse varius volutpat mattis. Vestibulum id magna est.</div>
      </div>
    </li>
    <li class="timeline-item" data-date="2017-06-01" data-src-low="assets/data/sites/aerotropix/low/2017-06@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2017-06.jpg">
      <div class="timeline-step">
        <time><span class="day">JUN</span><span class="month">2017</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">Aenean condimentum odio a bibendum rhoncus. Ut mauris felis, volutpat eget porta faucibus, euismod quis ante.</div>
      </div>
    </li>
    <li class="timeline-item" data-date="2017-08-01" data-src-low="assets/data/sites/aerotropix/low/2017-08@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2017-08.jpg">
      <div class="timeline-step">
        <time><span class="day">AUG</span><span class="month">2017</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">Vestibulum porttitor lorem sed pharetra dignissim. Nulla maximus, dui a tristique iaculis, quam dolor convallis enim, non dignissim ligula ipsum a turpis.</div>
      </div>
    </li>
    <li class="timeline-item" data-date="2017-09-01" data-src-low="assets/data/sites/aerotropix/low/2017-09@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2017-09.jpg">
      <div class="timeline-step">
        <time><span class="day">SEP</span><span class="month">2017</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">Väter haben viel zu tun, um es wieder gut zu machen, daß sie Söhne haben.<br>
Friedrich Wilhelm Nietzsche (1844 - 1900)</div>
      </div>
    </li>
    <li class="timeline-item" data-date="2017-11-01" data-src-low="assets/data/sites/aerotropix/low/2017-11@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2017-11.jpg">
      <div class="timeline-step">
        <time><span class="day">NOV</span><span class="month">2017</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">Vestibulum porttitor lorem sed pharetra dignissim. Nulla maximus, dui a tristique iaculis, quam dolor convallis enim, non dignissim ligula ipsum a turpis.</div>
      </div>
    </li>
    <li class="timeline-item" data-date="2017-12-01" data-src-low="assets/data/sites/aerotropix/low/2017-12@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2017-12.jpg">
      <div class="timeline-step">
        <time><span class="day">DEC</span><span class="month">2017</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">Vestibulum porttitor lorem sed pharetra dignissim. Nulla maximus, dui a tristique iaculis, quam dolor convallis enim, non dignissim ligula ipsum a turpis.</div>
      </div>
    </li>
    <li class="timeline-item last" data-date="2018-01-01" data-src-low="assets/data/sites/aerotropix/low/2018-01@0,5x.jpg" data-src-hd="assets/data/sites/aerotropix/2018-01.jpg">
      <div class="timeline-step">
        <time><span class="day">JAN</span><span class="month">2018</span></time> <span class="loading"><span class="progress"></span></span>
        <div class="memo">Vestibulum porttitor lorem sed pharetra dignissim. Nulla maximus, dui a tristique iaculis, quam dolor convallis enim, non dignissim ligula ipsum a turpis.</div>
      </div>
    </li>
  </ul>
</section>
<footer class="footer">
  <div class="col-1-3">
    <div class="footer-panel">
      <img src="images/scrbblr.eye.svg" class="svg color footer-logo">
    </div>
  </div><div class="col-2-3">
    
  </div>
</footer>
</article>
<div class="main-menu-panel">
  <ul>
    <li class="sub-menu help">
      <div class="menu-category"><img src="images/scrbblr.eye.svg" class="svg menu-logo"></div>
      <div class="menu-panel">
        <div class="menu-content">
          <div class="partners"><div class="partner aerotropix"><small>Powered by</small><img src="images/aerotropix.png"></div><div class="partner littfass"><small>Created by</small><img src="images/littfass.png"></div></div>
        </div>
      </div>
    </li>
    <li class="sub-menu settings">
      <div class="menu-category">Settings</div>
      <div class="menu-panel">
        <div class="menu-content">
          <div class="col-1-3 auto-row">
            <h3>Timeline settings</h3>
            <div class="setting">
              <div class="col-2-3 col-left">
                Soft transitions
              </div><div class="col-1-3 col-right">
                <div class="checkbox">
                  <input id="timeline-transition" name="timeline-transition" type="checkbox">
                  <label for="timeline-transition"></label>
                </div>
              </div>
            </div>
            <div class="setting">
              <div class="col-2-3 col-left">
                Slowmotion
              </div><div class="col-1-3 col-right">
                <div class="checkbox">
                  <input id="timeline-slowmotion" name="timeline-slowmotion" type="checkbox">
                  <label for="timeline-slowmotion"></label>
                </div>
              </div>
            </div>
            <div class="setting">
              <div class="col-2-3 col-left">
                Sticky scroll
              </div><div class="col-1-3 col-right">
                <div class="checkbox">
                  <input id="timeline-glue-scroll" name="timeline-glue-scroll" type="checkbox">
                  <label for="timeline-glue-scroll"></label>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </li>
    <li><a href="account.html" class="menu-category">Your Account</a></li>
    <li><a href="projects.html" class="menu-category">Your Projects</a></li>
    <li class="sub-menu help">
      <div class="menu-category">Help</div>
      <div class="menu-panel">
        <div class="menu-content">
          <h3>Timeline settings</h3>
          <p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p><p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p><p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p><p>Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet. Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua. At vero eos et accusam et justo duo dolores et ea rebum. Stet clita kasd gubergren, no sea takimata sanctus est Lorem ipsum dolor sit amet.</p>
        </div>
      </div>
    </li>
    <li><a href="editor.html" class="menu-category">Editor</a></li>
  </ul>
  <div class="option-menu">
    <nav class="btn-menu btn ico-menu"></nav>
  </div>
</div>

<!--audio preload="auto" id="beep" data-mono="beep">
  <source src="audio/beep.aac"></source>
  <source src="audio/beep.mp3"></source>
  <source src="audio/beep.ogg"></source>
</audio-->

<script>
$(function () {
let preLastTouchStartAt = 0;
let lastTouchStartAt = 0;
const delay = 500;

document.addEventListener('touchstart', () => {
  preLastTouchStartAt = lastTouchStartAt;
  lastTouchStartAt = +new Date();
  console.log("PREVENT TOUCHSTART");
});
document.addEventListener('touchend', (event) => {
  const touchEndAt = +new Date();
  if (touchEndAt - preLastTouchStartAt < delay) {
    event.preventDefault();
    event.target.click();
    console.log("PREVENT TOUCHEND");
  }
});
});
</script>
<script src="vendors/hammer.js"></script>
<script src="vendors/velocity.min.js"></script>
<!--script src="vendors/audio.js"></script-->
<script src="vendors/svg-inject.js"></script>
<script>
$(".svg").svgInject(function(){});
var isChrome = /Chrome/.test(navigator.userAgent) && /Google Inc/.test(navigator.vendor);
var isSafari = /Safari/.test(navigator.userAgent) && /Apple Computer/.test(navigator.vendor);

if(isChrome || isSafari){
  $('html').addClass("compliant");

var map = null;
var is_zoom = false;
var is_locked = false;
var is_fullsize = false;
var is_hd = false;
var is_timeline = false;
var is_plan = false;
var is_map = false;
var is_portrait = false;
var zoom_factor = 1;
var mapscroll = {x:0,y:0,w:0,h:0,sw:0,sh:0,px:null,py:null,percentx:null,percenty:null};
var selected = null;

var ratio = function(img){
  if(img.naturalHeight){
    return img.naturalWidth / img.naturalHeight;
  }
  return null;
};

var isPortrait = function(img,width,height){
  if(is_fullsize || was_fullsize){
    return !is_portrait;
  }
  
  var r = ratio(img);
  if(r && ((width / r) > height)){
    is_portrait = true;
  }
  else{
    is_portrait = false;
  }
  return is_portrait;
};

var isZoom = function(){
  return $('html').is(".zoom") ? true : false;
};

var isHD = function(){
  return $('html').is(".hd-loaded.hd-mode") ? true : false;
};

var isTimeline = function(){
  return $('html').is(".with-timeline") ? true : false;
};

var isFullSize = function(){
  return $('html').is(".fullsize") ? true : false;
};

var resizeMap = function(){
  if(isPortrait($('.touchscreen').get(0),$('.bounding-box').width(),$('.bounding-box').height())){
    $("html").addClass('portrait');
  }
  else{
    $("html").removeClass('portrait');
  }
  //resizeOpenStreetMap();
};

var pan = function(container,x,y){
  container.animate({scrollLeft:x,scrollTop:y},0);
};

var percent = function(n, count){
  if(count == 0) count = 1;
  return (100 - (n / count * 100)) / 100;
};

var scrollleft = 0;
var scrolltop = 0;
var touchscreen_timeout = null;

var isElementInViewport = function(el) {
  var rect = el.getBoundingClientRect();
  var h = rect.top - rect.bottom;
  return (
    rect.top >= (h) &&
    rect.left >= 0 &&
    rect.bottom <= ((window.innerHeight || document.documentElement.clientHeight) / 2 - h) &&
    rect.right <= (window.innerWidth || document.documentElement.clientWidth)
  );
};

var getHDSrc = function(src){
  return src.replace(/\@0\,5x/,"").replace(/low\//,"");
};


var checkStartMode = function(){
  if($(window).scrollTop() < 200){
    $('html').not('.start-mode').addClass("start-mode");
  }
  else{
    $('html.start-mode').removeClass("start-mode");
  }
};

var oldSrc = null;
var currentSrc = null;

var tmp_view = null;
var fade_in_timer = null;
var fade_out_timer = null;
var $touchscreen = $(".touchscreen");
var $fader = $(".fader");
var $plan = $(".plan");
var $main_date = $("time.date.main-date");


var rotateOnScroll = function(){
  h = $(".timeline").height() + $(".info").height() + 70;
  y = window.pageYOffset;
  p = percent(y,h);
  deg = 360 * p;
  //console.log(y,h,p,deg);
  document.getElementById("timeliner").style.transform = "translate3d(0,0,0) rotate(" + deg + "deg)";
};

var initViewport = function(){
  $(".map-item").eq(0).addClass("in-view selected");
};

var checkViewport = function() {
  if(is_zoom && !is_locked)return false;
  if(!is_zoom){
    checkStartMode();
    rotateOnScroll();
  }
  var is_first = true;
  $(".timeline li.timeline-item").each(function(){
    if (isElementInViewport(this)) {
      var $date = $(this).find("time").eq(0);
      if(is_first){
        is_first = false;        
        
        var src = isHD() ? $(this).attr("data-src-hd") : $(this).attr("data-src-low");
        
        if(is_zoom && !$('html').is(".locked")){
          src = $(this).attr("data-src-hd");
        }
        if((!is_zoom || $('html').is(".locked")) && oldSrc != src){
          if($(this).attr("data-src-plan") != $plan.attr("src")){
            $plan.attr("src", $(this).attr("data-src-plan"));
          }
          if($(".map-item.selected").attr("src") != src){
            $main_date.html($date.html());
            $(".map-item.selected").removeClass("selected");
            $(".map-item[src='" + src + "']").addClass("selected");
            $("[data-date].selected").removeClass("selected");
            $("[data-date='" + $(this).attr("data-date") + "']").addClass("selected");
            $(".map-item.selected").removeClass("fadein");
            if(fade_in_timer)clearTimeout(fade_in_timer);
            if(fade_out_timer)clearTimeout(fade_out_timer);
            fade_in_timer = setTimeout(function(){$(".map-item.selected").removeClass("unzoomed");},100);
            fade_out_timer = setTimeout(function(){$(".map-item.selected").addClass("fadein");},0);           
          } 
          
          oldSrc = src;
        }        
      }

      if(!is_zoom || is_locked){
        $(this).addClass("in-view");
      } 
    }
    else{
      if(!is_zoom || is_locked){
        $(this).removeClass("in-view");
      }
    }
  });
};

var startFullScreen = function(){
  var doc = document.documentElement;
  if(doc.requestFullScreen){
    doc.requestFullScreen();
  }
  else if(doc.mozRequestFullScreen){
    doc.mozRequestFullScreen();
  }
  else if(doc.webkitRequestFullScreen){
    doc.webkitRequestFullScreen();
  }
  $(".btn-fullscreen").addClass("fullscreen-exit");
  $(".btn-fullscreen .scroll-text").html("Switch to<br>browser mode");
};

var exitFullScreen = function(){
  if(document.exitFullScreen){
    document.exitFullScreen();
  }
  else if(document.msExitFullScreen){
    document.msExitFullScreen();
  }
  else if(document.mozCancelFullScreen){
    document.mozCancelFullScreen();
  }
  else if(document.webkitCancelFullScreen){
    document.webkitCancelFullScreen();
  }
  $(".btn-fullscreen").removeClass("fullscreen-exit");
  $(".btn-fullscreen .scroll-text").html("Switch to<br>preview mode");
};

var checkFullScreen = function(){
  return (document.fullscreenElement || document.mozFullScreen || document.webkitIsFullScreen);
};

var toggleFullScreen = function(){
  if(checkFullScreen()){
    exitFullScreen();
  }
  else{
    startFullScreen();
  }
};

var initFullScreen = function(){
  $(".btn-fullscreen").off("click").on("click", function(){
    toggleFullScreen();
  });
  
  $(".intro").off("dblclick").on("dblclick", function(){
    toggleFullScreen();
  });

  $(document).on("fullscreenchange mozfullscreenchange webkitfullscreenchange", function(){
    onFullScreenChange(checkFullScreen());
  });
};

var onFullScreenChange = function(is_fullscreen){

};

var registerTouch = function(type, dom, direction, options, cb){
  var touch = new Hammer(dom, options);
  touch.get('swipe').set({direction: direction,velocity:1.3,threshold:50});
  touch.on(type, cb);
};

var initPinch = function(){
  $(".touchscreen")[0].addEventListener('gestureend', function(e) {
    if (e.scale < 1.0) {
      console.log("PINCHED IN",e);
    } else if (e.scale > 1.0) {
      console.log("PINCHED OUT",e);
    }
  }, false);
  $(".touchscreen")[0].addEventListener('gesturestart', function(e) {
    console.log("START PINCH",e);
  }, false);
  $(".touchscreen")[0].addEventListener('gesturechange', function(e) {
    console.log("CHANGE PINCH",e.scale,e);
  }, false);
};

var initTouch = function(){
  registerTouch('swipe', $(".main-menu-panel").get(0),Hammer.DIRECTION_UP,{touchAction:'auto'},function(e){
    if($('html').is('.with-menu')){
      $('html').removeClass("with-menu");
      $('html,body').scrollTop(0);
    }
  });
  initPinch();
  /*registerTouch('swipe', $(".intro").get(0),Hammer.DIRECTION_DOWN,{},function(e){
    if(!$('body').is('.with-menu')){
      $('body').addClass("with-menu");
      $('html').addClass("with-menu");
    }
  });*/
};

var initTouch2 = function(){
  $(".main-menu-panel").on('swipeup', function(){
    if($('html').is('.with-menu')){
      $('html').removeClass("with-menu");
    }
  });
};

var showBounds = function(e){
  var $box = $('.bounding-box');
  var $img = $('.touchscreen');
  console.log("CLICK X",e.pageX,"CLICK X FIXED",e.pageX - $(window).scrollLeft(),"SCROLL X",$box.scrollLeft(),"SCROLL WIDTH",$box.get(0).scrollWidth,"BOX WIDTH",$box.width(),"BOX OUTER WIDTH",$box.outerWidth(),"BOX OFFSET X",$box.offset().left,"IMG OFFSET X",$img.offset().left,"WINDOW SCROLL X",$(window).scrollLeft());
  console.log("CLICK Y",e.pageY,"CLICK Y FIXED",e.pageY - $(window).scrollTop(),"SCROLL Y",$box.scrollTop(),"SCROLL HEIGHT",$box.get(0).scrollHeight,"BOX HEIGHT",$box.height(),"BOX OUTER HEIGHT",$box.outerHeight(),"BOX OFFSET Y",$box.offset().top,"IMG OFFSET Y",$img.offset().top,"WINDOW SCROLL Y",$(window).scrollTop());
};


var loadImage = function(imageUrl, onprogress) {
  return new Promise((resolve, reject) => {
    var xhr = new XMLHttpRequest();
    var notifiedNotComputable = false;

    xhr.open('GET', imageUrl, true);
    xhr.responseType = 'arraybuffer';

    xhr.onprogress = function(ev) {
        if (ev.lengthComputable) {
          onprogress(parseInt((ev.loaded / ev.total) * 100));
        } else {
          if (!notifiedNotComputable) {
            notifiedNotComputable = true;
            onprogress(-1);
          }
        }
    }

    xhr.onloadend = function() {
      if (!xhr.status.toString().match(/^2/)) {
        reject(xhr);
      } else {
        if (!notifiedNotComputable) {
          onprogress(100);
        }

        var options = {}
        var headers = xhr.getAllResponseHeaders();
        var m = headers.match(/^Content-Type\:\s*(.*?)$/mi);

        if (m && m[1]) {
          options.type = m[1];
        }

        var blob = new Blob([this.response], options);

        resolve(window.URL.createObjectURL(blob));
      }
    }

    xhr.send();
  });
};

var preloadHD = function(src, onprogress, onend, onerror){
  loadImage(src, (ratio) => {
    if(onprogress)onprogress(ratio, src);
  })
  .then(src => {
    if(onend)onend(src);
  }, xhr => {
    if(onerror)onerror(xhr, src);
  });
};

var preloadZoom = function(src){
  preloadHD(src, function(ratio){
    $(".progressbar").text(ratio + "%");
  }, function(){
    $(".progressbar").text("ready");
  }, function(err){
    
  });
};

var onPreloadProgress = function(ratio, src, dom){
  if (ratio == -1) {
    dom.progress.text("no HD");
  } else {
    txt = ratio + "%";
    dom.progress.text(txt);
  } 
};
var onPreloadEnd = function(ratio, src, dom){
  dom.image.get(0).src = src;
  dom.progress.text("HD");  
};

var media = [];
var media_hd = [];
var media_plans = [];

var buildScrob = function(items){
  console.log("ITEMS",items);
  for(i=0;i<items.length;i++){
    
    var image = items[i].item;
    image.id = "map-" + i;
    //$(image).addClass("loaded");
    //image.className = "map-item";
    $(".bounding-box")[0].appendChild(image);
  }
};
var buildScrobHD = function(items){
  console.log("HD ITEMS",items);
  for(i=0;i<items.length;i++){
    
    var image = items[i].item;
    image.id = "map-hd-" + i;
    //$(image).addClass("loaded");
    //image.className = "map-item";
    $(".bounding-box")[0].appendChild(image);
  }
};

var preloadImages = function(){
  $(".progressratio").text("preloading maps...");
  $(".timeline .timeline-item[data-src-low]").each(function(){
    media.push({url:$(this).attr('data-src-low'),hd:$(this).attr('data-src-hd'),item:null});
  });
  preload(media, "map", 0, function(current,count){
    $(".progressratio").text(Math.round(100 * (current + 1) / (count)) + "%");
  }, function(){
    buildScrob(media);
    $(".progressratio").text("");
    initViewport();
    $(".progressratio").text("maps loaded.");
    setTimeout(function(){$('html').removeClass("preloading");preloadPlans()},1000);
  });
};

var preloadPlans = function(){
  $(".progressratio").text("preloading plans...");
  $("[data-src-plan]").each(function(){
    media_plans.push({url:$(this).attr('data-src-plan')});
  });
  preload(media_plans,"plan", 0, function(current,count){

  }, function(){
    $('html').addClass('plans-loaded');
    $(".progressratio").text("plans loaded.");
    setTimeout(function(){preloadHDImages()},300);
  });
};

var preloadHDImages = function(){
  $(".progressratio").text("preloading HD maps...");
  $(".timeline .timeline-item[data-src-hd]").each(function(){
    media_hd.push({url:$(this).attr('data-src-hd'),hd:$(this).attr('data-src-hd'),item:null});
  });
  preload(media_hd, "map-hd", 0, function(current,count){
    $(".btn-preload .preload-ratio")[0].innerText = Math.round(100 * (current + 1) / (count));
  }, function(){
    buildScrobHD(media_hd);
    $(".progressratio").text("HD maps loaded.");
    $(".btn-preload")[0].innerHTML = 'HD';
    $('html').addClass('hd-loaded');
  });
};


var preload = function (images, type, index, onprogress, onend) {
  if(!$('html').is('.hd-loaded')){
    index = index || 0;
    if (images && images.length > index) {
      var image = new Image ();
      image.onload = function() {
        image.className = type + "-item loaded";
        if(onprogress)onprogress(index,images.length);
        preload(images, type, index + 1, onprogress, onend);
        image.onload = function(){};
      }
      images[index].item = image;
      if(images[index].hd)image.dataset.srcHd = images[index].hd;
      image.dataset.srcLow = images[index].url;
      image.src = images[index].url;
    }
    else{
      if(onend)onend();
    }
  }
};

var toggleHdMode = function(e){
  if($('html').is(".hd-mode")){      
    $('html').removeClass("hd-mode");
    $(".map-item[data-src-low]").each(function(){
      $(this).attr("src",$(this).attr("data-src-low"));
    });
    is_hd = false;
  }
  else{
    $('html').addClass("hd-mode");
    $(".map-item[data-src-hd]").each(function(){
      $(this).attr("src",$(this).attr("data-src-hd"));
    });
    is_hd = true;
  }
  console.log("HD",is_hd);
  //checkViewport();
};

var initHdMode = function(){
  $(".btn-preload").on('click',function(){
    if($('html').is('.hd-loaded'))toggleHdMode();
  });
};


var toggleLockTimer = null;
var toggleLock = function(e){
  if($('html').is(".locked")){
    $(".map-hd-item.selected").removeClass("selected");
    $(".map-hd-item[src='" + $(".map-item.selected").attr("data-src-hd") + "']").addClass("selected");
    $('html').removeClass("locked");
    is_locked = false;
    checkViewport();
  }
  else{
    $('html').addClass("locked");
    is_locked = false;
  }
  if(e){
    unzoom(e);
  }
};

var initLockMode = function(){
  $(".btn-lock").on('click',function(e){
    toggleLock();
  });
};

var touchscreen_timeout = null;
var zoom_timer = null;
var zooming = false;
var unzooming = false;
var was_fullsize = false;
var zoom = function(e){
  was_fullsize = is_fullsize;
  is_fullsize = false;
  resizeMap();
    if(touchscreen_timeout)clearTimeout(touchscreen_timeout);
    var selected_src = $(".map-item.selected").attr("data-src-hd");
    //$('.touchscreen').attr('src',selected_src);
    //var timelineWidth = isTimeline() ? $(".timescrub").width() : 0;
    var timelineWidth = isTimeline() ? 25 : 0;
    //console.log("TIMELINE WIDTH",isTimeline(),timelineWidth);
    var scrollleft = $('.bounding-box').scrollLeft();
    var scrolltop = $('.bounding-box').scrollTop();
    var posX = $('.touchscreen').offset().left;
    var posY = $('.touchscreen').offset().top;    
    var x = e.pageX + $(window).scrollLeft() - posX * 2;
    var y = e.pageY + $(window).scrollTop() - posY * 2;
    //$(".fader").attr("src", $(".touchscreen").attr("src"));
    
    //$(".hd").attr("src", getHDSrc($(".touchscreen").attr("src")));
    $(".bounding-box").removeClass('closed');
    var items = ".map-item.selected";
    if(is_plan)items += ",.plan";
    $(items).css({'transform-origin': ((x - scrollleft) * 2) + 'px ' + ((y - scrolltop) * 2) + 'px 0'});
    $('html').addClass("zoom");
    pan($('.bounding-box'),x ,y);
    //$('html').addClass("zoom-hd");
    if(zoom_timer){clearTimeout(zoom_timer);}
    zoom_timer = setTimeout(function(){
      $('html').addClass("zoom-hd");
      $(".map-hd-item.selected").removeClass("selected");
      $(".map-hd-item[src='" + selected_src + "']").addClass("selected");
      //$(".hd").attr("src", getHDSrc(selected_src));
    },1000);
};

var unzoom = function(e){
  is_fullsize = was_fullsize;
  resizeMap();
  if(zoom_timer){clearTimeout(zoom_timer);}
  var scrollleft = ($('.bounding-box').scrollLeft() - e.pageX + $(window).scrollLeft()) / 2;
  var scrolltop = ($('.bounding-box').scrollTop() - e.pageY + $(window).scrollTop()) / 2;      
  var x = (e.pageX - $(window).scrollLeft() + $('.bounding-box').scrollLeft()) / 2;
  var y = (e.pageY - $(window).scrollTop() + $('.bounding-box').scrollTop()) / 2;
  var items = ".map-item.selected";
  if($('html').is('.with-plan'))items += ",.plan";
  //".touchscreen,.plan,.map-item"
  $(items).css({'transform-origin': x + 'px ' + y + 'px 0'});   
  $('html').removeClass("zoom zoom-hd");
  pan($('.bounding-box'),scrollleft,scrolltop);
  $(".bounding-box").addClass('closed');
  if(touchscreen_timeout)clearTimeout(touchscreen_timeout);
  touchscreen_timeout = setTimeout(function(){
    $(".bounding-box").removeClass('closed');
  },300); 
};

var toggleZoom = function(e){
  resizeMap();
  if(!$('html').is(".locked")){      
    if(isZoom()){
      unzoom(e);
      map.setView([15.9876275,-61.7106999], 19);    
    }
    else{
      zoom(e);
      map.setView([15.9876275,-61.7106999], 20);
    }
  }
  else{
    return false;
  }
  //resizeOpenStreetMap();
};

var initZoom = function(){
  $(".touchscreen").on('click',function(e){
    if($('html').is(".locked")){
      toggleLock(e);
    }
    else{
      toggleZoom(e);
    }
  });
};


var timelineMode = 0;
var initTimelineMode = function(){
  $(".btn-timeline,.btn-calendar").off("click").on("click", function(){
    toggleTimelineMode();
  });
  $(document).on('close:timeline',function(){
    if($('html').is('.with-timeline')){
      timelineMode = -1;
      toggleTimelineMode(); 
    }
  });
};

var timelineModes = ["scroll","calendar"];

var toggleTimelineMode = function(){
  timelineMode += 1;
  for(i=0;i<=timelineModes.length;i++){
    $('html').removeClass('timeline-mode-' + i);
  }
  if(timelineMode <= 0){
    timelineMode = 0;
    $('html').removeClass('with-timeline');
    is_timeline = false;
  }
  else{
    $('html').addClass('timeline-mode-' + timelineMode);
    $('html').addClass('with-timeline');
    if(timelineMode == timelineModes.length){
      timelineMode = -1;
    }
    is_timeline = true;
  }
};

var planMode = 0;
var initPlanMode = function(){
  $(".btn-plan").off("click").on("click", function(){
    togglePlanMode();
  });
  $(document).on('close',function(){
    if($('html').is('.with-plan')){
      planMode = -1;
      togglePlanMode(); 
    }
  });
};

var planModes = ["1","2","3","4","5","6"];
var togglePlanMode = function(){
  $plan = $('.plan');
  planMode += 1;
  for(i=0;i<=planModes.length;i++){
    $plan.removeClass('plan-mode-' + i);
  }
  if(planMode <= 0){
    planMode = 0;
    $('html').removeClass('with-plan');
    is_plan = false;
  }
  else{
    $plan.attr("src",$plan.attr("data-plan-src"));
    $plan.addClass('plan-mode-' + planMode);
    $('html').addClass('with-plan');
    if(planMode == planModes.length){
      planMode = -1;
    }
    is_plan = true;
  }
};

var initTweenMode = function(){
  $(".btn-tween").off("click").on("click", function(){
    toggleTweenMode();
  });
};

var toggleTweenMode = function(){
  if($('html').is('.tween')){
    $('html').removeClass('tween');
  }
  else{
    $('html').addClass('tween');
  }
};

var initFullSize = function(){
  $(".btn-fullsize").off("click").on("click", function(){
    toggleFullSize();
  });
};

var toggleFullSize = function(){
  if($('html').is('.fullsize')){
    $('html').removeClass('fullsize');
    is_fullsize = false;
  }
  else{
    $('html').addClass('fullsize');
    is_fullsize = true;
  }
  resizeMap();
};

var onDblTap = function(dom,cb){
  var touch = new Hammer.Manager(dom);
  touch.add(new Hammer.Tap({event: 'doubletap', taps: 2}));
  //touch.get('doubletap').recognizeWith('singletap');
  touch.on("doubletap", function(e) {
    cb(e);
  });
};

var selectTimelineItem = function(item){
  //var y = $(item).offset().top;
  item.scrollIntoView({
    behavior: "auto",
    block: "start"
  });
  window.scrollTop += 50;
  checkViewport();
  //$(window).scrollTop(y + 150);
};

var initButtons = function(){
  $('.btn').on('click',function(){
    if($(this).is('.btn-active')){
      $(this).removeClass("btn-active");
    }
    else{
      $(this).addClass("btn-active");
    }
  });
  $('.btn-close').on('click',function(){
    $(document).trigger("close");
  });
  $('.timeline time').on('click',function(){
    selectTimelineItem(this);
  });
};

var initMenu = function(){
  $('.btn-menu').on('click',function(){
    if($('html').is('.with-menu')){
      $('html').removeClass("with-menu");
    }
    else{
      $('html').addClass("with-menu");
    }
  });
};

var getDays = function (startDate, endDate, addFn, interval) {

 addFn = addFn || Date.prototype.addDays;
 interval = interval || 1;

 var retVal = [];
 var current = new Date(startDate);

 while (current <= endDate) {
  retVal.push(new Date(current));
  current = addFn.call(current, interval);
 }

 return retVal;
};

var calendar = {dates:[],data:{}};

var freeze_timer = null;
var initCalendar = function(){
  $(".timeline .timeline-item[data-date]").each(function(){
    calendar.dates.push(this.dataset.date);
  });
  calendar.dates = calendar.dates.sort();
  for(i=0;i<calendar.dates.length;i++){
    d = new Date(calendar.dates[i]);
    t = d.getTime();
    item = $("[data-date='" + calendar.dates[i] + "']").get(0);
    calendar.data[calendar.dates[i]] = {date:d, timestamp:t, value:calendar.dates[i], src_low:item.dataset.srcLow, src_hd:item.dataset.srcHd, src_plan:item.dataset.srcPlan};
  }
  
  paintCalendar($('.calendar-dates')[0]);
  
  /*$(".calendar-dates-scroller").on('scroll',function(){
    $('html').addClass('freeze');
    if(freeze_timer)clearTimeout(freeze_timer);
    freeze_timer = setTimeout(function(){
      $('html').removeClass('freeze');
    },2000);
  });
  $(".calendar-dates-scroller").on('mouseleave',function(){
    $('html').removeClass('freeze');
  });*/
};

var paintCalendar = function(container){
  dom = [];
  for(i=0;i<calendar.dates.length;i++){
    dom.push(createCalendarItem(calendar.data[calendar.dates[i]]));
  }
  container.innerHTML = dom.reverse().join("");
  $('.calendar .timeline-item').off('click').on('click',function(){
    var date = this.dataset.date;
    var item = $(".timeline .timeline-item[data-date='" + date + "'] time")[0];
    selectTimelineItem(item);    
  }); 
};


var language = "en"
var months = {en:["Jan","Feb","Mar","Apr","Mai","Jun","Jul","Aug","Sep","Okt","Nov","Dec"]};
var createCalendarItem = function(data){
  date = data.date ? '<time><span class="day">' + months[language][data.date.getMonth()] + '</span><span class="month">' + data.date.getFullYear() + '</span></time>' : "";
  return '<li class="timeline-item bg-color-alt" data-date="' + data.value + '"><div class="timeline-step">' + date + '</div></li>';
};

$(window).on('load resize',function(e){
  resizeMap();
  checkViewport(e);
  resizeOpenStreetMap();
});
//$(window).on("scroll", checkViewport);


;(function() {
    var throttle = function(type, name, obj) {
        var obj = obj || window;
        var running = false;
        var func = function() {
            if (running) { return; }
            running = true;
            requestAnimationFrame(function() {
                obj.dispatchEvent(new CustomEvent(name));
                running = false;
            });
        };
        obj.addEventListener(type, func);
    };
    throttle ("scroll", "optimizedScroll");
})();

window.addEventListener("optimizedScroll", function(e) {
  checkViewport();
});

var initSettings = function(){
  $(".menu-category").on("click",function(){
    $menu = $(this).parent();
    $panel = $menu.find(".menu-panel");
    $content = $panel.find(".menu-content");
    $panel.toggleClass("opened");
    var height = $panel.is(".opened") ? $content.outerHeight() : 0;
    //alert(height + " vs " + $content.height());
    $panel.css({'max-height': height});
    $(".main-menu-panel").animate({
         scrollTop: $menu.offset().top
      }, {
         duration: 300,
         ease: "ease-out"
      });
  });
  $("#timeline-transition").on("change",function(){
    if($(this).is(':checked')){
      $('html').addClass("tween");
    }
    else{
      $('html').removeClass("tween");
    }
  });
  $("#timeline-slowmotion").on("change",function(){
    if($(this).is(':checked')){
      $('html').addClass("slowmotion");
    }
    else{
      $('html').removeClass("slowmotion");
    }
  });
  $("#timeline-glue-scroll").on("change",function(){
    if($(this).is(':checked')){
      $('html').addClass("glue-scroll");
    }
    else{
      $('html').removeClass("glue-scroll");
    }
  });
};




var mapMode = 0;
var initMapMode = function(){
  createMap();
  $(".btn-map").off("click").on("click", function(){
    toggleMapMode();
  });
};

var mapModes = ["1","2"];
var toggleMapMode = function(){
  $map = $('#map');
  mapMode += 1;
  for(i=0;i<=mapModes.length;i++){
    $map.removeClass('map-mode-' + i);
  }
  if(mapMode <= 0){
    mapMode = 0;
    $('html').removeClass('with-map');
    is_map = false;
  }
  else{
    $map.addClass('map-mode-' + mapMode);
    $('html').addClass('with-map');
    if(mapMode == mapModes.length){
      mapMode = -1;
    }
    is_map = true;
  }
};

var createMap = function(){
  if(!map){
    map = L.map('map'); 
    map.options.minZoom = 12;
    var gl = L.mapboxGL({
        accessToken: '{token}',
        style: 'https://openmaptiles.github.io/osm-bright-gl-style/style-cdn.json'
    }).addTo(map);
    map.setView([15.9876275,-61.7106999], 19);
  }
};

var removeMap = function(){  
  //map.remove();
  //map = null;
};

var resizeOpenStreetMap = function(){
  $("#map").width($(".map-item").eq(0).width());
  $("#map").height($(".map-item").eq(0).height());
  if(map)map.invalidateSize();
};

$(document).ready(function(){
  initSettings();
  resizeMap();
  initTimelineMode();
  initFullScreen();
  initFullSize();
  initTweenMode();
  //initHdMode();
  initLockMode();
  initPlanMode();
  initTouch();
  initButtons();
  initMenu();
  initZoom();
  initCalendar();
  //initMapMode();
});

$(window).on('load',function(){
  preloadImages();
});

}
else{
  $('html').addClass("not-compliant");
}
</script>
</body>
</html>